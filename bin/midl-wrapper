#!/bin/sh

#
# midl-wrapper
#
# Wraps calls to the Microsoft IDL compiler (MIDL), with these aims:
#  - fix compile errors in output code that occur under GNU C compiler (gcc)
#  - use GNU C preprocessor (cpp)
#  - swallow stdout chatter
#

##
## Configuration
##

# -Oicf is the preferred option; we cannot use this because the Mingw import
# library for 'rpcrt4.dll' is missing the function NdrServerCall2. -Oi is
# deprecated and will eventually be removed.
#
# See also: http://msdn.microsoft.com/en-us/library/aa367352(v=VS.85).aspx
MIDL_STUB_MODE="-Oi"

# Generate C code using GNU cpp to avoid requiring MSVC.
MIDL_C_OPTIONS="-cpp_cmd cpp -cpp_opt \"-E\""

MIDL_OPTIONS="-nologo $MIDL_C_OPTIONS $MIDL_STUB_MODE"


##
## Script
##

while [ $# -gt 0 ]; do
  if [ "$1" = "-o" ]; then
    output_path=$2
    MIDL_OPTIONS="-out $output_path $MIDL_OPTIONS"
    shift 2
  elif [ "$1" = "-m" ]; then
    MIDL=$2
    shift 2
  else
    break
  fi
done

if [ -z $1 ] || [ $1 == "--help" ]; then
  echo "\
Usage: $0 [-o DIR] IDL_FILE

    -o DIR: place generated source files into DIR"
  exit 255
fi


if [ -z $MIDL ]; then
  MIDL=midl.exe
fi

if [ ! -x $MIDL ]; then
  echo "Unable to locate $MIDL"
  exit 2
fi

idl_file=$1

if [ ! -e $idl_file ]; then
  echo "Unable to locate $idl_file"
  exit 1
fi

acf_file=$2

if [ -e $acf_file ]; then
  MIDL_OPTIONS="$MIDL_OPTIONS -acf $acf_file"
fi

$MIDL $MIDL_OPTIONS $idl_file | sed -e /^Processing.*/d


extension=${idl_file##*.}
base=`basename $idl_file .$extension`

if [ -n $output_path ] && [ "$output_path" != "" ]; then
  base="$output_path/$base"
fi

# The generated code for some reason uses 'extern' for forward
# declarations of constants that are defined further down the same
# file. This (understandably) confuses gcc.
FIX_FORWARD_DECLS="s/extern const/static const/"

sed -i -e "$FIX_FORWARD_DECLS" ${base}_c.c
sed -i -e "$FIX_FORWARD_DECLS" ${base}_s.c
